---
displayNumber: 158
status: closed
priority: 2
createdAt: 2026-02-10T10:52:14.725004+00:00
updatedAt: 2026-02-10T11:07:15.471503+00:00
---

# Extract ConfigService from CentyDaemon

Decompose the monolithic `CentyDaemon` gRPC service by extracting `GetManifest`, `GetConfig`, and `UpdateConfig` into a standalone `ConfigService`. Both services continue to run on the same tonic server/port. This is the first step in incrementally splitting the monolith into per-domain services.

## Approach

Keep everything in the **same proto file and `centy.v1` package** — define a second `service ConfigService` block. This avoids multi-file proto compilation complexity while cleanly separating the service at the gRPC level. Shared message types remain accessible to both services.

## Changes

### Proto: `proto/centy/v1/centy.proto`
- Add a new `service ConfigService` block with the 3 RPCs (GetManifest, GetConfig, UpdateConfig)
- Remove these 3 RPCs from the `CentyDaemon` service block
- All message types stay where they are (same file, same package)

### Rust: `src/server/mod.rs`
- Add `ConfigServiceImpl` unit struct (no state needed — config handlers are stateless)
- Add `mod config_trait_impl;` declaration

### Rust: `src/server/config_trait_impl.rs` (new file)
- `impl ConfigService for ConfigServiceImpl` with the 3 methods, delegating to existing handlers (`handlers::manifest::get_manifest`, `handlers::config::get_config`, `handlers::config_update::update_config`)
- Same pattern as `trait_impl.rs` but for the new trait

### Rust: `src/server/trait_impl.rs`
- Remove the 3 methods (`get_manifest`, `get_config`, `update_config`) from `impl CentyDaemon for CentyDaemonService`

### Rust: `src/main.rs`
- Import `config_service_server::ConfigServiceServer` alongside `CentyDaemonServer`
- Import `ConfigServiceImpl`
- Create `ConfigServiceImpl` instance
- Add `.add_service(ConfigServiceServer::new(config_service))` to the server builder

### E2E: `e2e/fixtures/grpc-client.ts`
- Add `ConfigClient` interface with the 3 config/manifest methods
- Add `createConfigClient()` function using `protoDescriptor.centy.v1.ConfigService`
- Remove config/manifest methods from `CentyClient` interface
- In `promisifyClient`: accept a second `configClient` parameter, wire config methods to it
- Update `createGrpcClient` to return both clients

### E2E: `e2e/fixtures/temp-project.ts`
- Update `createGrpcClient` / `promisifyClient` call sites to include config client

### E2E: `e2e/fixtures/cli-wrapper.ts`
- Update client construction to include config client

### No changes needed
- `e2e/fixtures/daemon-manager.ts` (only uses `getDaemonInfo` and `shutdown`)
- `e2e/config.e2e.spec.ts` (works if promisified client still exposes same methods)
- Handler files (`config.rs`, `config_update.rs`, `manifest.rs`) — standalone functions, unchanged
- `build.rs` — both services in same `.proto` file, compiled together

## Verification
1. `cargo build` — confirms proto compilation produces both `centy_daemon_server` and `config_service_server` modules
2. `cargo test` — confirms no regressions
3. `cd e2e && pnpm test -- config` — confirms e2e config tests pass against the new service
4. gRPC reflection — verify both services show up
