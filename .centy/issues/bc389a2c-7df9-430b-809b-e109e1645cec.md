---
displayNumber: 142
status: open
priority: 2
createdAt: 2026-02-06T00:26:51.162529+00:00
updatedAt: 2026-02-06T00:26:51.162529+00:00
---

# Add config validation middleware to run before every gRPC request

## Summary

Add a Tower middleware layer that validates config.json before processing each incoming gRPC request. Currently, config validation only runs during the UpdateConfig RPC handler — if the config file is manually edited or corrupted outside the daemon, subsequent requests may operate on invalid configuration silently.

## Motivation

* Config can be edited outside the daemon (it’s a file on disk at .centy/config.json)
* Invalid config (e.g. missing allowed_states, default_state not in allowed_states, priority_levels out of range) can cause unexpected behavior across all RPCs
* Early rejection with a clear error is better than silent corruption or panics

## Proposed Approach

1. Create a new ConfigValidationLayer / ConfigValidationService Tower middleware (following the existing GrpcLoggingLayer pattern in src/grpc_logging.rs)
1. Reuse the existing validate_config() function from src/server/mod.rs
1. Register it in the server builder chain in src/main.rs
1. On validation failure, return a gRPC FAILED_PRECONDITION status with the validation error message before the request reaches the service handler

## Considerations

* **Performance**: Reading and validating config on every request adds I/O overhead. Consider caching the config with file-watcher invalidation, or at minimum an in-memory cache with a short TTL
* **Scope**: Decide whether all RPCs need validation or if some (e.g. GetConfig, Shutdown) should be excluded
