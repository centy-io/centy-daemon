#!/bin/sh
set -e

# Spell check on staged files (soft fail if cspell unavailable)
if command -v cspell >/dev/null 2>&1; then
    echo "Running cspell on staged files..."
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)
    if [ -n "$STAGED_FILES" ]; then
        echo "$STAGED_FILES" | xargs cspell --no-progress
    fi
else
    echo "Warning: cspell not found, skipping spell check"
fi

# Check for forbidden lint suppressions
echo "Checking for forbidden lint suppressions..."
if grep -r --include="*.rs" '#\[allow(clippy::too_many_lines)\]' src/; then
    echo "Error: Found #[allow(clippy::too_many_lines)] directive(s) in source code."
    echo "Please refactor long functions instead of suppressing the lint."
    exit 1
fi

echo "Checking file size limit..."
bash scripts/check-file-size.sh

echo "Running Clippy with pedantic lints..."
# Allow too_many_lines (false positive on tonic impl blocks), deny all other warnings
cargo clippy --all-targets -- -D warnings -A clippy::too_many_lines
