#!/bin/sh
set -e

echo "Pre-push checks starting..."

echo "[1/6] Checking formatting..."
cargo fmt --all -- --check

echo "[2/6] Checking for forbidden lint suppressions..."
if grep -r --include="*.rs" '#\[allow(clippy::too_many_lines)\]' src/; then
    echo "Error: Found #[allow(clippy::too_many_lines)] directive(s) in source code."
    echo "Please refactor long functions instead of suppressing the lint."
    exit 1
fi

echo "[3/6] Running Clippy..."
# Allow too_many_lines (false positive on tonic impl blocks), deny all other warnings
cargo clippy --all-targets -- -D warnings -A clippy::too_many_lines

echo "[4/6] Type checking..."
cargo check --all-targets

echo "[5/6] Building project..."
cargo build --all-targets

echo "[6/6] Running tests..."
cargo test --all-targets

echo "Pre-push checks passed!"
