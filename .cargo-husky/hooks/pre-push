#!/bin/sh
set -e

echo "Pre-push checks starting..."

echo "[1/8] Checking formatting..."
cargo fmt --all -- --check

echo "[2/8] Checking file size limit..."
bash scripts/check-file-size.sh

echo "[3/8] Checking for forbidden lint suppressions..."
if grep -r --include="*.rs" '#\[allow(clippy::too_many_lines)\]' src/; then
    echo "Error: Found #[allow(clippy::too_many_lines)] directive(s) in source code."
    echo "Please refactor long functions instead of suppressing the lint."
    exit 1
fi

echo "[4/8] Running Clippy..."
# Allow too_many_lines (false positive on tonic impl blocks), deny all other warnings
cargo clippy --all-targets -- -D warnings -A clippy::too_many_lines

echo "[5/8] Type checking..."
cargo check --all-targets

echo "[6/8] Building project..."
cargo build --all-targets

echo "[7/8] Running tests..."
cargo test --all-targets

echo "[8/8] Running e2e tests..."
cd e2e && pnpm test && cd ..

echo "Pre-push checks passed!"
